name: Arduino CLI Build

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Install STM32 board support
        run: |
          arduino-cli core install STMicroelectronics:stm32 --additional-urls https://github.com/stm32duino/BoardManagerFiles/raw/main/package_stmicroelectronics_index.json
          arduino-cli board list

      - name: Build sketch for STM32L432KC
        run: |
          arduino-cli compile --fqbn STMicroelectronics:stm32:Nucleo_L432KC:upload_method=STLink,xserial=generic -v

      - name: Find and list build artifacts
        run: |
          echo "Build artifacts:"
          find . -name "*.elf" -o -name "*.bin" -o -name "*.hex" 2>/dev/null | head -20

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            build/**
            ./**/*.elf
            ./**/*.bin
